// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// AUTH

model User {
  id Int @id @default(autoincrement())

  name  String?
  login Login?

  createdPages      Page[]
  createdContainers Container[]
  createdContents   Content[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Login {
  id Int @id @default(autoincrement())

  userId   Int       @unique
  user     User      @relation(fields: [userId], references: [id])
  sessions Session[]
  roleId   Int?
  role     Role?     @relation(fields: [roleId], references: [id])

  root Boolean @default(false)

  email    String @unique
  password String
}

model Session {
  id Int @id @default(autoincrement())

  token String @unique @default(cuid())

  loginId   Int
  login     Login    @relation(fields: [loginId], references: [id], onDelete: Cascade)
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// RIGHTS & ACCESS

model Role {
  id Int @id @default(autoincrement())

  name   String
  logins Login[]
  rights RightType[]

  limitImageUpload Int?
  limitFileUpload  Int?
  limitVideoUpload Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RightType {
  VIEW_ALL_PAGE
  VIEW_MY_PAGE
  CREATE_PAGE
  UPDATE_ALL_PAGE
  UPDATE_MY_PAGE
  DELETE_PAGE
  UPDATE_PAGE_SECTION

  VIEW_ALL_CONTAINER
  VIEW_MY_CONTAINER
  CREATE_CONTAINER
  UPDATE_ALL_CONTAINER
  UPDATE_MY_CONTAINER
  DELETE_CONTAINER
  UPDATE_CONTAINER_SECTION
  UPDATE_CONTAINER_TEMPLATE_SECTION

  VIEW_ALL_CONTENT
  VIEW_MY_CONTENT
  CREATE_CONTENT
  UPDATE_ALL_CONTENT
  UPDATE_MY_CONTENT
  DELETE_CONTENT
  UPDATE_CONTENT_SECTION

  VIEW_ALL_MEDIA
  VIEW_MY_MEDIA
  UPLOAD_MEDIA
  UPDATE_MEDIA
  DELETE_MEDIA

  VIEW_ALL_FORM
  VIEW_MY_FORM
  CREATE_FORM
  UPDATE_ALL_FORM
  UPDATE_MY_FORM
  DELETE_FORM

  VIEW_MESSAGE
  READ_MESSAGE
  DELETE_MESSAGE

  VIEW_USER
  CREATE_USER
  UPDATE_USER
  DELETE_USER

  VIEW_ROLE
  CREATE_ROLE
  UPDATE_ROLE
  DELETE_ROLE

  VIEW_LAYOUT
  UPDATE_LAYOUT

  VIEW_SETTING
  UPDATE_GENERAL
  UPDATE_THEME
  UPDATE_SMTP

  REVALIDATE
}

// FORMS

model Form {
  id Int @id @default(autoincrement())

  name           String  @unique
  redirectMail   Boolean @default(false)
  mailToRedirect String?
  successMessage String?
  errorMessage   String?
  extraData      Json

  messages     Message[]
  fields       FormField[]
  // sections       Section[]
  // elements       Element[]
  discontinued Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  usedInSection LinkedToSection[]
}

enum FormFieldType {
  TEXT
  NUMBER
  EMAIL
  PASSWORD
  PARAGRAPH
  OPTION
  CHECKBOX
  RADIO
  BUTTON
  TITLE
}

model FormField {
  id Int @id @default(autoincrement())

  formId      Int
  form        Form          @relation(fields: [formId], references: [id])
  name        String?
  type        FormFieldType
  label       String
  placeholder String?

  position Int
  line     Int

  messageFields MessageField[]

  options Json?

  min Float?
  max Float?

  defaultText     String?
  defaultNumber   Float?
  defaultMultiple Json?

  required Boolean? @default(false)

  updatedAt DateTime @updatedAt
}

model Message {
  id Int @id @default(autoincrement())

  marked Boolean        @default(false)
  read   Boolean        @default(false)
  fields MessageField[]

  formId Int
  form   Form @relation(fields: [formId], references: [id])

  createdAt DateTime @default(now())
}

model MessageField {
  id Int @id @default(autoincrement())

  messageId Int
  message   Message @relation(fields: [messageId], references: [id])

  formFieldId Int
  formField   FormField @relation(fields: [formFieldId], references: [id])

  valueText    String?
  valueNumber  Int?
  valueBoolean Boolean?
}

// SETTINGS

enum SettingType {
  REVALIDATE_DELAY
  APP_NAME
  BACKGROUND_COLOR
  PRIMARY_COLOR
  SECONDARY_COLOR
  PRIMARY_TEXT_COLOR
  SECONDARY_TEXT_COLOR
  DARK_COLOR
  LIGHT_COLOR
  EXTRA_COLOR
  MAIL_HOST
  MAIL_PORT
  MAIL_USER
  MAIL_PASS
  SIDEBAR_IS_ACTIVE
  SIDEBAR_WIDTH
  SIDEBAR_UNIT
  SIDEBAR_POSITION
  SIDEBAR_COLOR
  SIDEBAR_BREAKPOINT_SIZE
  MAINTENANCE_MODE
}

model Setting {
  id Int @id @default(autoincrement())

  type    SettingType @unique
  value   String
  visible Boolean     @default(true)

  updatedAt DateTime @updatedAt
}

// SLUGS

model Slug {
  id Int @id @default(autoincrement())

  full  String @unique
  basic String

  // parentId Int?
  // parent   Slug?  @relation(fields: [parentId], references: [id], name: "childs")
  // childs   Slug[] @relation(name: "childs")

  pageId Int?  @unique
  page   Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)
  // containerId String?    @unique
  // container   Container? @relation(fields: [containerId], references: [id])
  // contentId   String?    @unique
  // content     Content?   @relation(fields: [contentId], references: [id])

  updatedAt DateTime @updatedAt
}

// METADATAS

model Metadata {
  id Int @id @default(autoincrement())

  name    String
  content String

  LinkedPageId      Int?
  LinkedPage        Page?      @relation(fields: [LinkedPageId], references: [id], onDelete: Cascade)
  LinkedContainerId Int?
  LinkedContainer   Container? @relation(fields: [LinkedContainerId], references: [id], onDelete: Cascade)
  LinkedContentId   Int?
  LinkedContent     Content?   @relation(fields: [LinkedContentId], references: [id], onDelete: Cascade)
}

// SECTIONS

enum SectionType {
  PAGE
  PAGE_SIDEBAR

  CONTAINER
  CONTAINER_SIDEBAR

  TEMPLATE
  TEMPLATE_TOP
  TEMPLATE_BOTTOM
  TEMPLATE_SIDEBAR

  CONTENT
  CONTENT_SIDEBAR

  LAYOUT_HEADER
  LAYOUT_FOOTER

  LAYOUT_CONTENT_TOP
  LAYOUT_CONTENT_BOTTOM

  LAYOUT_SIDEBAR_TOP
  LAYOUT_SIDEBAR_BOTTOM
}

model Section {
  id Int @id @default(autoincrement())

  type     SectionType
  block    String
  position Int

  content Json

  // Element releated
  pageId Int?
  page   Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Linked data
  medias LinkedToSection[]
}

model LinkedToSection {
  id Int @id @default(autoincrement())

  sectionId Int
  section   Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  mediaId   Int?
  media     Media?  @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  formId    Int?
  form      Form?   @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@unique([sectionId, mediaId])
}

// PAGES

enum PageType {
  PAGE
  HOMEPAGE
  SIGNIN
  NOTFOUND
  ERROR
  MAINTENANCE
}

model Page {
  id Int @id @default(autoincrement())

  name String
  type PageType @default(PAGE)

  slug Slug?

  metadatas Metadata[]
  sections  Section[]

  published Boolean @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUserId Int?
  createdBy       User?    @relation(fields: [createdByUserId], references: [id])
}

// CONTAINERS

model Container {
  id Int @id @default(autoincrement())

  fields   ContainerField[]
  metadata Metadata[]

  contents Content[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUserId Int?
  createdBy       User?    @relation(fields: [createdByUserId], references: [id])
}

enum ContainerFieldType {
  STRING
  NUMBER
  DATE
  BOOLEAN
  LINK
  PARAGRAPH
  IMAGE
  FILE
  VIDEO
  CONTENT
  OPTION
  RICHTEXT
  COLOR
  LOCATION
}

model ContainerField {
  id Int @id @default(autoincrement())

  containerId Int
  container   Container @relation(fields: [containerId], references: [id], onDelete: Cascade)

  position Int
  type     ContainerFieldType
  multiple Boolean

  metadata String[]

  min Int?
  max Int?

  startDate DateTime?
  endDate   DateTime?
  valueMin  Float?
  valueMax  Float?

  defaultTextValue           String?
  defaultMultipleTextValue   String[]
  defaultNumberValue         Float?
  defaultMultipleNumberValue Float[]
  defaultDateValue           DateTime?
  defaultMultipleDateValue   DateTime[]
  defaultJSON                Json?
  defaultMultipleJSON        Json[]

  releatedFields ContentField[]
}

// CONTENTS

model Content {
  id Int @id @default(autoincrement())

  containerId Int
  container   Container @relation(fields: [containerId], references: [id], onDelete: Cascade)

  fields    ContentField[]
  metadatas Metadata[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdByUserId Int?
  createdBy       User?    @relation(fields: [createdByUserId], references: [id])
}

model ContentField {
  id Int @id @default(autoincrement())

  contentId Int
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Copy from parent field
  position Int
  type     ContainerFieldType
  multiple Boolean

  releatedFieldId Int
  releatedField   ContainerField @relation(fields: [releatedFieldId], references: [id], onDelete: Cascade)

  textValue           String?
  multipleTextValue   String[]
  numberValue         Float?
  multipleNumberValue Float[]
  dateValue           DateTime?
  multipleDateValue   DateTime[]
}

// MEDIAS

enum MediaType {
  IMAGE
  VIDEO
  FILE
}

model Media {
  id Int @id @default(autoincrement())

  type MediaType

  uri      String  @unique
  mimeType String
  name     String
  size     Int
  alt      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usedInSections LinkedToSection[]
}
